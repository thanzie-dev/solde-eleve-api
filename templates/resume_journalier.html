<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<link rel="stylesheet" href="/static/style.css">


<title>Résumé journalier</title>
</head>


<body>

<!-- ================= HEADER ================= -->

<div class="header-container">

<div class="header-left">
<img src="{{ url_for('static', filename='images/logo_csnst.png') }}" alt="Logo">

<div class="header-bands">
<div class="band-blue"></div>
<div class="band-red"></div>

<div class="scrolling-text">
<span>Complexe scolaire Nsanga le Thanzie : Discipline - Excellence - Travail</span>
</div>
</div>
</div>

<div class="header-center">
Bienvenue au Complexe Scolaire Nsanga Le Thanzie<br>
Résumé journalier — Année {{ annee }}<br>
RAPPORT CAISSE
</div>

<div class="header-right">
COMPLEXE SCOLAIRE<br>
NSANGA LE THANZIE<br>
<a href="/thz" class="logout-btn">Déconnexion</a>
</div>

</div>

<!-- ================= FILTRE ================= -->

<form method="get" class="filtre-form">
<label>Du :
<input type="date" name="date_debut" value="{{ date_debut or '' }}">
</label>

<label style="margin-left:10px;">Au : <input type="date" name="date_fin" value="{{ date_fin or '' }}"> </label>

<input type="hidden" name="annee" value="{{ annee }}">
<button type="submit">Filtrer</button>
</form>

<!-- ================= TABLEAU ================= -->

<table>

<thead>
<tr class="group-header">
<th rowspan="2">Date</th>
<th colspan="6">ENTRÉES</th>
<th colspan="3">DÉPENSES</th>
<th rowspan="2">SOLDE</th>
</tr>

<tr class="sub-header">
<th>Report</th>
<th>Bloc 1</th>
<th>Bloc 2</th>
<th>Bus 1</th>
<th>Bus 2</th>
<th>Total Entrées</th>
<th>N° Dép.</th>
<th>Total Dép.</th>
<th>Banque</th>
</tr>
</thead>

<tbody>
{% for r in rows %}
<tr>

<td>{{ r.date_jour.strftime('%d/%m/%Y') if r.date_jour }}</td>

<td class="entree">{{ "%.2f"|format(r.report or 0) }}</td>
<td class="entree">{{ "%.2f"|format(r.bloc1 or 0) }}</td>
<td class="entree">{{ "%.2f"|format(r.bloc2 or 0) }}</td>
<td class="entree">{{ "%.2f"|format(r.bus1 or 0) }}</td>
<td class="entree">{{ "%.2f"|format(r.bus2 or 0) }}</td>

<td class="entree"><strong>{{ "%.2f"|format(r.tot_entr or 0) }}</strong></td>

<td class="depense">
{{ r.nb_depenses or 0 }}
<button type="button" class="btn-detail"
onclick="afficherDepenses('{{ r.date_jour.strftime('%Y-%m-%d') if r.date_jour }}')">
Détails
</button>
</td>

<td class="depense">{{ "%.2f"|format(r.total_depenses or 0) }}</td>
<td class="depense">{{ "%.2f"|format(r.banque or 0) }}</td>

<td class="solde {% if r.solde < 0 %}negatif{% else %}positif{% endif %}">
{{ "%.2f"|format(r.solde or 0) }}
</td>

</tr>
{% endfor %}
</tbody>

<tfoot>
<tr>
<td>TOTAL</td>

<td class="entree">{{ "%.2f"|format(totaux.report) }}</td>
<td class="entree">{{ "%.2f"|format(totaux.bloc1) }}</td>
<td class="entree">{{ "%.2f"|format(totaux.bloc2) }}</td>
<td class="entree">{{ "%.2f"|format(totaux.bus1) }}</td>
<td class="entree">{{ "%.2f"|format(totaux.bus2) }}</td>

<td class="entree">{{ "%.2f"|format(totaux.tot_entr) }}</td>

<td></td>

<td class="depense">{{ "%.2f"|format(totaux.total_depenses) }}</td>
<td class="depense">{{ "%.2f"|format(totaux.banque) }}</td>

<td class="solde {% if totaux.solde < 0 %}negatif{% else %}positif{% endif %}">
{{ "%.2f"|format(totaux.solde) }}
</td>
</tr>
</tfoot>

</table>

<!-- ================= PANNEAU DÉPENSES ================= -->

<div id="depenses-panel" class="depenses-panel" style="display:none;">

    <div id="depenses-info"></div>

    <table id="depenses-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Réf Dép.</th>
                <th>Libellé</th>
                <th>Montant</th>
                <th>Année scolaire</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>


<script>

function afficherDepenses(date) {

    const panel = document.getElementById("depenses-panel");
    const info  = document.getElementById("depenses-info");
    const tbody = document.querySelector("#depenses-table tbody");

    const annee = "{{ annee }}";

    // Affiche le panneau
    panel.style.display = "block";

    // Vide l'ancien contenu
    tbody.innerHTML = "";
    info.innerHTML = "Chargement...";

    fetch(`/api/depenses-par-date?date=${date}&annee=${annee}`)
        .then(r => r.json())
        .then(data => {

            info.innerHTML = `
                <strong>Date :</strong> ${data.date}
                — <strong>Nombre de dépenses :</strong> ${data.nb}
            `;

            data.depenses.forEach((d, i) => {

                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${d.ref_dp || ""}</td>
                    <td>${d.libelle}</td>
                    <td style="text-align:right;">${d.montant}</td>
                    <td>${d.annee_scolaire}</td>
                `;

                tbody.appendChild(tr);
            });

        })
        .catch(err => {
            info.innerHTML = "Erreur de chargement des dépenses.";
            console.error(err);
        });
}

</script>



</body>
</html>
